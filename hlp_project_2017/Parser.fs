namespace ARM7TDMI

module Parser=

    open Type
    open Emulator

    let whiteSpace = [| ' '; '\f'; '\t'; '\r' |]
        
    /// matches string returning integer
    let (|IsLit|_|) (s:string) = 
        try 
            int s |> Some
        with _ -> None
    /// matches string returning integer
    let (|IsReg|_|) s =
        let ParseToReg =
            function
            | "R0" -> R0
            | "R1" -> R1
            | "R2" -> R2
            (*
            | "R3" -> R3
            | "R4" -> R4
            *)
            //exception
            | _ -> invalidOp "register does not exist"  
        try 
            ParseToReg s |> Some
        with _ -> None
    /// matches RegOrLit string returning the RegOrLit
    (*
    let (|IsRegOrLit|_|) =
        function
        | IsReg reg -> Reg(reg)
        | IsLit lit -> Lit(lit)
        | _ -> None
    *)
        
        

    let parse = 
            let splitIntoWords (s:string) = 
                s.Split whiteSpace 
                |> Array.filter ((<>) "") // delete empty strings generated by default .Split function
            let executeWordsAsCommand = function
                | [ "MOV"; IsReg reg1; IsReg reg2 ] -> MOV(reg1,Reg(reg2))
                | [ "MOV"; IsReg reg; IsLit n ] -> MOV(reg,Lit(n))
                | [ "ADD"; IsReg reg1; IsReg reg2; IsReg reg3 ] -> ADD(reg1,Reg(reg2),Reg(reg3))
                | [ "ADD"; IsReg reg1; IsReg reg2; IsLit n ] -> ADD(reg1,Reg(reg2),Lit(n))
                | [ "ADD"; IsReg reg1; IsLit n; IsReg reg2 ] -> ADD(reg1,Lit(n),Reg(reg2))
                | [ "ADD"; IsReg reg; IsLit n1; IsLit n2 ] -> ADD(reg,Lit(n1),Lit(n2))
                | [ "SUB"; IsReg reg1; IsReg reg2; IsReg reg3 ] -> SUB(reg1,Reg(reg2),Reg(reg3))
                | [ "SUB"; IsReg reg1; IsReg reg2; IsLit n ] -> SUB(reg1,Reg(reg2),Lit(n))
                | [ "SUB"; IsReg reg1; IsLit n; IsReg reg2 ] -> SUB(reg1,Lit(n),Reg(reg2))
                | [ "SUB"; IsReg reg; IsLit n1; IsLit n2 ] -> SUB(reg,Lit(n1),Lit(n2))
                | _ -> invalidOp "parse failed"         
            splitIntoWords
            >> Array.toList
            >> executeWordsAsCommand

